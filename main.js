const video=document.getElementById('video'),canvas=document.getElementById('canvas'),ctx=canvas.getContext('2d'),translateBtn=document.getElementById('translate'),captureBtn=document.getElementById('capture'),registerBtn=document.getElementById('register'),switchBtn=document.getElementById('switch'),gallery=document.getElementById('gallery');let model,currentFacingMode='environment',faceMatcher,descriptors=[];async function startCamera(facingMode){const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{exact:facingMode}},audio:false});video.srcObject=stream;}Promise.all([cocoSsd.load(),faceapi.nets.tinyFaceDetector.loadFromUri('./models')]).then(([cocoModel])=>{model=cocoModel;startCamera(currentFacingMode).then(()=>{video.addEventListener('loadeddata',detect);initMap();});});async function detect(){canvas.width=video.videoWidth;canvas.height=video.videoHeight;async function frame(){ctx.clearRect(0,0,canvas.width,canvas.height);ctx.drawImage(video,0,0,canvas.width,canvas.height);const predictions=await model.detect(video);predictions.forEach(pred=>{ctx.strokeStyle='#00FF00';ctx.lineWidth=2;ctx.strokeRect(...pred.bbox);ctx.fillStyle='#00FF00';ctx.fillText(pred.class,pred.bbox[0],pred.bbox[1]>10?pred.bbox[1]-5:10);});const detections=await faceapi.detectAllFaces(video,new faceapi.TinyFaceDetectorOptions());detections.forEach(det=>{const{x,y,width,height}=det.box;ctx.strokeStyle='red';ctx.lineWidth=2;ctx.strokeRect(x,y,width,height);ctx.fillStyle='red';ctx.fillText('Face',x,y>10?y-5:10);});requestAnimationFrame(frame);}frame();}function initMap(){const map=L.map('map').setView([35.681236,139.767125],14);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);}switchBtn.onclick=()=>{currentFacingMode=currentFacingMode==='user'?'environment':'user';startCamera(currentFacingMode);};captureBtn.onclick=()=>{const img=document.createElement('img');img.src=canvas.toDataURL('image/png');gallery.appendChild(img);saveImage(img.src);};function saveImage(data){const dbReq=indexedDB.open('edithDB',1);dbReq.onupgradeneeded=e=>{const db=e.target.result;db.createObjectStore('images',{autoIncrement:true});};dbReq.onsuccess=e=>{const db=e.target.result,tx=db.transaction('images','readwrite'),store=tx.objectStore('images');store.add(data);};}